---
title: "Mappe e Codici confini amministrativi ISTAT"
subtitle: "Materiale intermedio su dati geografici con R"
date: last-modified
date-format: "DD-MMMM-YYYY"
lang: it

format: html
  # html:
  #   theme: flatly #spacelab
    # css: utils/style.css
    # code-fold: true # redundant bc echo false 
    # toc-depth: 3
    # toc_float: true
    # toc-location: left
    # toc-title: Indice
    # embed-resources: true # external dependencies embedded (Not in ..._files/)

execute:
  eval: true
  echo: false # x mostrare codice anche in file docx
  warning: false
  error: false
  output: false
  
bibliography: bib/CRP_dash.bib
suppress-bibliography: false
---

<!-- # üò´ tutto da ripensare  -->
<!-- https://chatgpt.com/share/69131e82-4ac8-800f-a8b8-8ea511714f30 -->

## R packg

```{r}
#| label: setup

# --- Pacchetti (load but suppress warning) --- 
library(here)
library(sf)
library(readxl)
library(janitor, warn.conflicts = FALSE, quietly = TRUE)

library(dplyr, warn.conflicts = FALSE, quietly = TRUE)
library(stringr, quietly = TRUE)
library(janitor, quietly = TRUE)
library(tidyr, quietly = TRUE)

library(ggplot2, quietly = TRUE)
library(ggrepel, quietly = TRUE)
library(leaflet, quietly = TRUE)
library(tmap, quietly = TRUE)
library(flextable, quietly = TRUE)

# source(here("R","f_ft_formatting.R"))
```

# 1) Carica dati 


## __ Carica `.shp files` ISTAT

**FONTE**: vedi `data/data_in/istat_shp_ITA/_istat_shp_ITA_spiega.md`
**DATA AGGIORNAMENTO**: 01/01/2025
**COME OTTENUTO**: presi da download manuale (vedi `_istat_shp_ITA_spiega.md`)
**CONTENUTO**:
  + Shapefiles dei confini amministrativi italiani al 01/01/2025 (Comuni, Province/Citt√† Metropolitane, Regioni, Ripartizioni geografiche)


```{r}
#| label: data-load

# =========================================================
# Italia 2025 (ISTAT, WGS84) ‚Äî Lettura, pulizia e mappe
# Requisiti: sf, dplyr, ggplot2
# File attesi nella working directory:
#  - Com01012025_WGS84.shp          (Comuni)
#  - ProvCM01012025_WGS84.shp       (Province/Citt√† Metropolitane)
#  - Reg01012025_WGS84.shp          (Regioni)
#  - RipGeo01012025_WGS84.shp       (Ripartizioni geografiche)
# =========================================================

source(here("R","istat_shp_get.R"))

# Cartella base dove stanno gli shapefile ISTAT
istat_sh_path <- here("data", "data_in", "istat_shp_ITA")

# Legge tutti gli shapefile 2025
istat_sh_2025 <- istat_shp_get(istat_sh_path)

# Assegna agli oggetti che usi nel resto del documento
comuni_ita      <- istat_sh_2025$comuni_ita
province_cm_ita <- istat_sh_2025$province_cm_ita
regioni_ita     <- istat_sh_2025$regioni_ita
ripartizioni_ita    <- istat_sh_2025$ripartizioni_ita

# (opzionale) se vuoi subito filtrare le ripartizioni:
# ripartizioni <- dplyr::filter(ripartizioni, COD_RIP == "2")
```

```{r}
#| label: check-crs
st_crs(comuni_ita)
st_crs(province_cm_ita)
st_crs(regioni_ita)
st_crs(ripartizioni_ita)

# ---------- (IF needed) Allinea layers alla stessa proiezione (EPSG:32632): ----------
crs_target       <- st_crs(comuni_ita)
province_cm_ita  <- st_transform(province_cm_ita, crs = crs_target)
regioni_ita      <- st_transform(regioni_ita, crs = crs_target)
# ripartizioni <- st_transform(ripartizioni, crs = crs_target)
```

## __ Carica caratteristiche comuni SITUAS 

**FONTE**: ISTAT SITUAS - Servizi di pubblicazione dati territoriali 
**DATA AGGIORNAMENTO**: quella in cui si scaricano i dati 
**COME OTTENUTO**:  usando funzione per scaricare dati da SITUAS con API (`R/istat_situas_get.R`)
**CONTENUTO**:
  + AMBITI GEOGRAFICI: Unit√† amministrative (Comuni)
  + In questo caso mi serve il **Report 73	Comuni - Caratteristiche del territorio**
  + Qui c'√® la lista dei report territoriali [https://situas.istat.it/web/#/apiDetail](https://situas.istat.it/web/#/apiDetail)


```{r}
source(here("R","istat_situas_get.R"))

# Scarica elenco comuni alla data odierna
ID_REPORT <- 73
com_caratt <- f_scarica_situas_dati(id_report = ID_REPORT) # 7896 comuni 

# com_caratt2  <-  com_caratt |> 
#   select(1:12, ZONE_COST_2021, DEGURBA_2021 )
 
#com_caratt_meta <- f_scarica_situas_metadati(id_report = ID_REPORT)
```

# 2) Prepara sf per regioni/province/comuni di interesse

## __ Prep dati per Emilia-Romagna 

```{r}
#| label: shp-er

source(here("R","istat_situas_sf_prep.R"))

# ---------- Filtro Emilia-Romagna (COD_REG == "8") ----------
er_out_dir <- here("data", "data_out", "ER_shp")

er_res <- istat_situas_sf_prep(
  comuni_ita      = comuni_ita,
  province_cm_ita = province_cm_ita,
  regioni_ita     = regioni_ita,
  cod_reg         = "8",    # Emilia-Romagna (ISTAT)
  out_dir         = er_out_dir,
  cod_prov        = "34",   # Parma (ISTAT)
  nome_reg        = "ER",   # tua sigla (opzionale) 
  nome_prov       = "PR"    # tua sigla (opzionale)
)

names(er_res)
# [1] "ER_comuni_sf"        "ER_provincie_sf"    "ER_regioni_sf"
#     "ER_PR_comuni_sf"    "ER_PR_provincie_sf"

# Se vuoi oggetti "piatti" nell'ambiente del chunk:
ER_comuni_sf        <- er_res$ER_comuni_sf
ER_provincie_sf     <- er_res$ER_provincie_sf
ER_regioni_sf       <- er_res$ER_regioni_sf
ER_PR_comuni_sf     <- er_res$ER_PR_comuni_sf
ER_PR_provincie_sf  <- er_res$ER_PR_provincie_sf

```


### [Fun] Salva liste codici 
```{r}
source(here("R","write_codici_vec.R"))
```

### --- Salva liste codici per ER
```{r}
# er_out_dir <- here("data", "data_out", "ER_shp")

# Lista codici provincie ER
write_codici_vec(
  x   = ER_provincie_sf,
  col      = "COD_PROV",
  vec_name = "CODICI_PROV_ER",
  out_path = here("data", "data_out", "ER_shp", "lista_COD_PROV_er_vec.R")
)
 
# Lista codici comuni ER
write_codici_vec(
  x        = ER_comuni_sf,
  col      = "PRO_COM_T",
  vec_name = "CODICI_COMUNI_ER",
  out_path = here("data", "data_out", "ER_shp", "lista_PRO_COM_T_er_vec.R")
)

# Lista codici comuni ER-PR
write_codici_vec(
  x        = ER_PR_comuni_sf,
  col      = "PRO_COM_T",
  vec_name = "CODICI_COMUNI_ER_PR",
  out_path = here("data", "data_out", "ER_shp", "lista_PRO_COM_T_er_pr_vec.R")
)

```

## __ Prep dati per Lombardia

```{r}
#| label: shp-lm

#source(here("R","istat_situas_sf_prep.R"))

# ---------- Filtro Lombardia (COD_REG == "3") ----------
lomb_out_dir <- here("data", "data_out", "LB_shp")

lomb_res <- istat_situas_sf_prep(
  comuni_ita      = comuni_ita,
  province_cm_ita = province_cm_ita,
  regioni_ita     = regioni_ita,
  cod_reg         = "3",    # Lombardia (ISTAT)
  out_dir         = lomb_out_dir,
  cod_prov        = "18",   # PV (ISTAT)
  nome_reg        = "LB",  # tua sigla arb
  nome_prov       = "PV"   # tua sigla arb
)

names(lomb_res)
# [1] "LB_comuni_sf"       "LB_provincie_sf"    "LB_regioni_sf"      "LB_PV_comuni_sf"    "LB_PV_provincie_sf"

# Se vuoi oggetti "piatti" nell'ambiente del chunk:
LB_comuni_sf        <- lomb_res$LB_comuni_sf
LB_provincie_sf     <- lomb_res$LB_provincie_sf
LB_regioni_sf       <- lomb_res$LB_regioni_sf
LB_PV_comuni_sf     <- lomb_res$LB_PV_comuni_sf
LB_PV_provincie_sf  <- lomb_res$LB_PV_provincie_sf
```


### --- Salva liste codici per Lomb
```{r}
# lomb_out_dir <- here("data", "data_out", "LB_shp")

# Lista codici provincie LB
write_codici_vec(
  x   =  LB_provincie_sf,
  col = "COD_PROV",
  vec_name = "CODICI_PROV_LB",
  out_path = here("data", "data_out", "LB_shp", "lista_COD_PROV_lb_vec.R")
)
 
# Lista codici comuni LB
write_codici_vec(
  x        = LB_comuni_sf,
  col      = "PRO_COM_T",
  vec_name = "CODICI_COMUNI_LB",
  out_path = here("data", "data_out", "LB_shp", "lista_PRO_COM_T_lb_vec.R")
)

# Lista codici comuni LB-PV
write_codici_vec(
  x        = LB_PV_comuni_sf,
  col      = "PRO_COM_T",
  vec_name = "CODICI_COMUNI_LB_PV",
  out_path = here("data", "data_out", "LB_shp", "lista_PRO_COM_T_lb_pv_vec.R")
) 

```



# 3) Join Caratt Comuni (SITUAS) + Shp comuni (ISTAT)

```{r}
#| label: join-comuni-shp

# Funzione che fa join tra dati SITUAS e shapefile ISTAT 
# e poi da versione ridotta con colonne utili che salva in file rds 
source(here("R","istat_situas_join_comuni_sf.R"))

res_comuni_info <- istat_situas_join_comuni_sf(
  comuni_sf    = comuni_ita,
  situas_df    = com_caratt,
  out_dir      = here("data","data_out"),
  out_basename = "comuni_ita_info_redux_sf"  # opzionale, questo √® gi√† il default
)

comuni_ita_info_sf       <- res_comuni_info$comuni_info_sf
comuni_ita_info_redux_sf <- res_comuni_info$comuni_info_redux_sf

class(comuni_ita_info_sf)
# [1] "sf" "data.frame"
class(comuni_ita_info_redux_sf)
# [1] "sf" "data.frame"
```


Based on codice  alfanumerico = `PRO_COM_T`

```{r}
#| label: join-comuni_shp

class(com_caratt)
class(comuni_ita) # must be 1st in join to keep sf geometry

# ---- JOIN (sf on the left)
comuni_ita_info_sf <- 
  left_join(comuni_ita,com_caratt, 
            by = c("PRO_COM_T") ) |> 
  # drop the .y versions
  select(-ends_with(".y")) %>% 
  # remove .x from the names
  rename_with(~ sub("\\.x$", "", .), ends_with(".x")) |> 
  relocate(c("Shape_Leng","Shape_Area"), .before = "geometry")

class(comuni_ita_info_sf)
# [1] "sf"         "data.frame"
```



## --- Descrizione VARs `comuni_ita_info_sf`

Fonte: vedi [https://situas-servizi.istat.it/publish/anagrafica_report_metadato_web?pfun=73&pdata=01/01/1948](https://situas-servizi.istat.it/publish/anagrafica_report_metadato_web?pfun=73&pdata=01/01/1948)

```{r}
comuni_ita_info_sf_VARDESC <- tribble(
  ~COLNAME, ~LABEL, ~NOTE, ~GUIDA,
  # da situas
  "COD_RIP", "Codice Ripartizione geografica", "Note non presenti",
  "Codice Istat della ripartizione geografica secondo la suddivisione del territorio nazionale in: 1) Nord-ovest, 2) Nord-est, 3) Centro, 4) Sud e 5) Isole.",
  
  "COD_REG", "Codice Regione", "Valore di due caratteri alfanumerici, con validit√† nell'intervallo 01-20.",
  "Codice Istat della regione",
  "COD_UTS", "Codice Provincia/Uts", "Codice di tre caratteri alfanumerici con validit√† nell‚Äôintervallo 001-119 per le Province. Restano assegnati ai Liberi consorzi i codici delle omonime ex Province (081-089). Il codice delle Citt√† metropolitane √® ottenuto sommando '200' al codice della Provincia corrispondente. Ai soli fini statistici permangono i codici delle soppresse Province del Friuli-Venezia Giulia (L.r. 20/2016).",
  "Codice Istat della Provincia o Unit√† territoriale sovracomunale (Uts). Le unit√† territoriali sovracomunali comprendono, a fini statistici, Province, Citt√† metropolitane, Liberi consorzi e unit√† non amministrative (ex Province del Friuli-Venezia Giulia).",
  "COD_PROV_STORICO", "Codice Provincia (Storico)", "Dal 1/1/2015 con l'entrata in vigore delle Citt√† metropolitane i codici delle province corrispondenti permangono al solo scopo di costituire il codice del Comune, che non subisce variazioni. Permangono anche i codici delle soppresse Province del Friuli-Venezia Giulia (L.r. 20/2016).",
  "Codice Istat della Provincia vigente o cessata (tre caratteri alfanumerici, validi nell‚Äôintervallo 001-119).",
  "PRO_COM_T", "Codice Comune (alfanumerico)", "Note non presenti",
  "Codice Istat del Comune di sei caratteri in formato alfanumerico",
  "PRO_COM", "Codice comune (numerico)", "Note non presenti",
  "Codice Istat del Comune di sei caratteri in formato numerico",
  "COMUNE", "Comune", "Denominazione ufficiale dei comuni della Provincia di Bolzano/Bozen e di alcuni del Friuli-Venezia Giulia. Per le denominazioni bilingue si usa '/' per Bolzano/Bozen e '-' per gli altri.",
  "Denominazione del Comune in lingua italiana e straniera",
  "COMUNE_A", "Comune (dizione straniera)", "Note non presenti",
  "Denominazione del Comune in lingua diversa dall'italiano",
  "SIGLA_AUTOMOBILISTICA", "Sigla automobilistica", "Note non presenti",
  "Sigla automobilistica della provincia o, dal 2015, della citt√† metropolitana, libero consorzio o unit√† non amministrativa (ex province del Friuli-Venezia Giulia). Null se non disponibile.",
  "COM_ISO", "Comune isolano", "Comuni appartenenti alle isole minori o lacuali. Sant'Antioco (SU) ha sezioni anche sull'Isola maggiore; Monte Isola (BS) √® l'unico comune lacuale.",
  "1=Comune isolano; 0=Comune non isolano; null se non disponibile.",
  "COM_LIT", "Comune litoraneo", "Comune con almeno un tratto di confine bagnato dal mare. Sono esclusi i comuni lacuali.",
  "1=Comune litoraneo; 0=Comune non litoraneo; null se non disponibile.",
  "ZONA_ALT", "Zona altimetrica", "Ripartizione del territorio in zone omogenee basate su soglie altimetriche.",
  "1=Montagna interna; 2=Montagna litoranea; 3=Collina interna; 4=Collina litoranea; 5=Pianura; null se non disponibile.",
  "ZONE_COST_2011", "Zone costiere 2011", "Classificazione dei comuni secondo la vicinanza alla costa, basata su dati Istat ed Eurostat, armonizzata a livello UE (Reg. 2017/2391 e 2019/1130).",
  "1=Zone costiere (costa o ‚â•50% superficie entro 10 km dal mare); 0=Zone non costiere; null se non disponibile.",
  "ZONE_COST_2021", "Zone costiere 2021", "Classificazione aggiornata delle zone costiere (Eurostat e Istat).",
  "1=Zone costiere (costa o ‚â•50% superficie entro 10 km dal mare); 0=Zone non costiere; null se non disponibile.",
  "DEGURBA_2011", "Degurba 2011", "Classificazione armonizzata del grado di urbanizzazione (Eurostat), basata su Geostat grid 2011.",
  "1=Citt√† o zone densamente popolate; 2=Piccole citt√†/sobborghi; 3=Zone rurali; null se non disponibile.",
  "DEGURBA_2021", "Degurba 2021", "Classificazione armonizzata del grado di urbanizzazione (Eurostat), basata su Geostat grid 2021.",
  "1=Citt√† o zone densamente popolate; 2=Piccole citt√†/sobborghi; 3=Zone rurali; null se non disponibile.",
  "COD_ECO_DIV_2018", "Codice Ecoregioni-Divisioni", "Note non presenti",
  "Livello gerarchico che distingue 2 Divisioni: Temperata e Mediterranea; null se non disponibile.",
  "DEN_ECO_DIV_2018", "Ecoregioni - Divisioni", "Note non presenti",
  "Guida non presente",
  "COD_ECO_PRO_2018", "Codice Ecoregioni-Province", "Note non presenti",
  "Livello gerarchico articolato in 7 Province, rappresenta la regionalizzazione ecologica e geografica del territorio; null se non disponibile.",
  "DEN_ECO_PRO_2018", "Ecoregioni - Province", "Note non presenti",
  "Guida non presente",
  "COD_ECO_SEZ_2018", "Codice Ecoregioni-Sezioni", "Note non presenti",
  "Livello gerarchico di 11 Sezioni per rappresentare un quadro ecologico di riferimento pi√π dettagliato; null se non disponibile.",
  "DEN_ECO_SEZ_2018", "Ecoregioni - Sezioni", "Note non presenti",
  "Guida non presente",
  "COD_ECO_SSEZ_2018", "Codice Ecoregioni-Sottosezioni", "Note non presenti",
  "Livello gerarchico con 33 Sottosezioni per descrivere con maggiore dettaglio il quadro ecologico del territorio; null se non disponibile.",
  "DEN_ECO_SSEZ_2018", "Ecoregioni - Sottosezioni", "Note non presenti",
  "Guida non presente",  
  # da shapefile
  "COD_PROV", "Codice Provincia", "", "Codice Istat della Provincia o Citt√† metropolitana di appartenenza del Comune.",
  "COD_CM", "Codice Citt√† metropolitana", "", "Codice Istat della Citt√† metropolitana di appartenenza del Comune. Null se non disponibile.",
  "CC_UTS", "Codice Unit√† territoriale sovracomunale", "", "Codice Istat dell'Unit√† territoriale sovracomunale (Uts) di appartenenza del Comune. Le unit√† territoriali sovracomunali comprendono, a fini statistici, Province, Citt√† metropolitane, Liberi consorzi e unit√† non amministrative (ex Province del Friuli-Venezia Giulia).",
  "Shape_Leng", "Lunghezza forma", "", "Lunghezza del perimetro del comune in metri.",
  "Shape_Area", "Area forma", "", "Area del comune in metri quadrati.",
  "geometry", "Geometria", "", "Geometria del comune in formato 'sf' (Simple Features)."
  
)


# ordine colonne come nel file finale
col_order <- c(
  "COD_RIP", "COD_REG", "COD_PROV", "COD_CM",
  "COD_UTS", "PRO_COM", "PRO_COM_T", "COMUNE",
  "COMUNE_A", "CC_UTS", "COD_PROV_STORICO", "SIGLA_AUTOMOBILISTICA",
  "COM_ISO", "COM_LIT", "ZONA_ALT", "ZONE_COST_2011",
  "ZONE_COST_2021", "DEGURBA_2011", "DEGURBA_2021",
  "COD_ECO_DIV_2018", "DEN_ECO_DIV_2018",
  "COD_ECO_PRO_2018", "DEN_ECO_PRO_2018",
  "COD_ECO_SEZ_2018", "DEN_ECO_SEZ_2018",
  "COD_ECO_SSEZ_2018", "DEN_ECO_SSEZ_2018",
  "Shape_Leng", "Shape_Area", "geometry"
)

comuni_ita_info_sf_VARDESC <- comuni_ita_info_sf_VARDESC |>
  mutate(
    FONTE = if_else(
      COLNAME %in% c(
        "COD_PROV", "COD_CM", "CC_UTS",
        "Shape_Leng", "Shape_Area", "geometry"
      ),
      "ISTAT ‚Äì Limiti amministrativi al 01/01/2025 (shapefile WGS84)",
      "ISTAT SITUAS ‚Äì Caratteristiche del territorio, Report 73"
    )
  ) |>
  arrange(match(COLNAME, col_order))

comuni_ita_info_sf_VARDESC

```

## --- Salva oggetto con info comuni + descrizione variabili
```{r}
# # Salva per riuso in altri qmd
# salva_vardesc_rds <- function(df) {
#   dir.create(here::here("data", "data_out", "tbl"), showWarnings = FALSE, recursive = TRUE)
#   saveRDS(
#     df,
#     file = here::here("data", "data_out", "tbl", "comuni_ita_info_sf_VARDESC.rds")
#   )
#   invisible(df)
# }

source(here::here("R","utilities.R"))

salva_vardesc_rds(comuni_ita_info_sf_VARDESC, 
                  out_path = here::here("data", "data_out", "tbl", "comuni_ita_info_sf_VARDESC.rds")
)

```

