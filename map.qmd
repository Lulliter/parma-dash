---
title: "Mappa"
#subtitle: "(JA EUCanScreen - WP 6.1)"
date: last-modified
date-format: "DD-MMMM-YYYY"
lang: it

format: html
  # html:
  #   theme: flatly #spacelab
    # css: utils/style.css
    # code-fold: true # redundant bc echo false 
    # toc-depth: 3
    # toc_float: true
    # toc-location: left
    # toc-title: Indice
    # embed-resources: true # external dependencies embedded (Not in ..._files/)

# execute:
#   eval: true
#   echo: false # x mostrare codice anche in file docx
#   warning: false
#   error: false
#   output: false
  
# bibliography: bib/ATS.bib
# suppress-bibliography: false
---


Mappa dei comuni (usando dati ISTAT )

```{r}
#| label: setup
#| eval: true
#| echo: false


# --- Pacchetti (load but suppress warning) --- 
suppressPackageStartupMessages({
  library(here)
  library(sf)
  library(dplyr, warn.conflicts = FALSE, quietly = TRUE)
  library(ggplot2, quietly = TRUE)
})

```

## Lettura dei dati cartografici ISTAT
```{r}
#| label: data-load
#| eval: true
#| echo: false

# =========================================================
# Italia 2025 (ISTAT, WGS84) — Lettura, pulizia e mappe
# Requisiti: sf, dplyr, ggplot2
# File attesi nella working directory:
#  - Com01012025_WGS84.shp          (Comuni)
#  - ProvCM01012025_WGS84.shp       (Province/Città Metropolitane)
#  - Reg01012025_WGS84.shp          (Regioni)
#  - RipGeo01012025_WGS84.shp       (Ripartizioni geografiche)
# =========================================================

# --------- Path shapefiles ---------
data_path <- here("data_map","Limiti01012025")


# ---------- Lettura shapefile (senza .cpg: forziamo ENCODING=UTF-8) ----------
comuni_ita       <- st_read(here(data_path,"Com01012025","Com01012025_WGS84.shp"),
                        options = "ENCODING=UTF-8", quiet = TRUE)
province_cm_ita  <- st_read(here(data_path,"ProvCM01012025","ProvCM01012025_WGS84.shp"),
                        options = "ENCODING=UTF-8", quiet = TRUE)
regioni_ita      <- st_read(here(data_path,"Reg01012025","Reg01012025_WGS84.shp"),
                        options = "ENCODING=UTF-8", quiet = TRUE)
# ripartizioni <- st_read(here("data_map","Limiti01012025","RipGeo01012025","RipGeo01012025_WGS84.shp"),
#                         options = "ENCODING=UTF-8", quiet = TRUE) |> 
#   filter (COD_RIP == "2")
  
# ---------- Allinea gli altri layer alla stessa proiezione dei comuni (EPSG:32632): ----------
crs_target <- st_crs(comuni_ita)
province_cm_ita  <- st_transform(province_cm_ita, crs = crs_target)
regioni_ita      <- st_transform(regioni_ita, crs = crs_target)
# ripartizioni <- st_transform(ripartizioni, crs = crs_target)

# ---------- Filtro Emilia-Romagna (COD_REG == "8") ----------
comuni_er  <- dplyr::filter(comuni_ita,  COD_REG == "8")
province_er <- dplyr::filter(province_cm_ita, COD_REG == "8")
regioni_er <- dplyr::filter(regioni_ita, COD_REG == "8")

# --------- Seleziona Provincia di Parma ----------
prov_parma <- dplyr::filter(province_cm_ita, COD_PROV == "34")
```


```{r}
#| label: recap
#| eval: true
#| echo: false

# --------- Piccolo riepilogo ----------
data.frame(
  layer = c("regioni_er","province_er", "comuni_er"),
  n = c( nrow(regioni_er),nrow(province_er),  nrow(comuni_er)),
  epsg = c(st_crs(regioni_er)$epsg, st_crs(province_er)$epsg, st_crs(comuni_er)$epsg)
  )
```

### Coordinate Reference System (CRS)
Generalmente, si usano coordinate geografiche (long/lat) in `WGS84 (EPSG:4326)`. Ma in questo caso i dati ISTAT sono in `UTM 32N (EPSG:32632)`, che è un sistema di coordinate proiettate (in metri).

Lavorando con mappe di piccole aree (come una regione), è preferibile usare un sistema di coordinate proiettate, che mantiene meglio le distanze e le aree.

```{r}
#| eval: true
#| echo: false
#| output: false
#| warning: false

# --------- Verifica CRS ----------
st_crs(comuni_er)
st_area(comuni_er)
st_is_longlat(comuni_er) # FALSE -> non è in latlong

# ---- to transform to latlong (WGS84) ----
# comuni_er_ll <- st_transform(comuni_er, crs = 4326)


```


## [Fig 1] Mappa amministrativa dell'Emilia-Romagna con comuni e provincie

```{r}
#| label: map-base
#| eval: true
#| echo: false
#| ouptput: true
#| fig-cap: "Base cartografica: Comuni (grigio), Province (blu), Regione (blu scuro)."
#| fig-alt: "Mappa amministrativa dell'Emilia-Romagna con comuni, confini provinciali e regionali."
#| out-width: 100%

p <- ggplot() +
  geom_sf(data = comuni_er, fill = "#F4F4F4", color = "grey75", linewidth = 0.08) +
  geom_sf(data = province_er, fill = NA, color = "#4E79A7", linewidth = 0.4) +
  geom_sf(data = regioni_er, fill = NA, color = "#1B263B", linewidth = 0.8) +
  coord_sf(datum = NA) +
  labs(
    title = "Emilia-Romagna — Base amministrativa",
    subtitle = "Comuni in grigio chiaro, confini provinciali e regionali in blu",
    caption = "Fonte: ISTAT — Limiti amministrativi al 01/01/2025"
  ) +
  # x evitare che le etichette degli assi vengano visualizzate
  # Evita problemi di rendering in HTML
  coord_sf(datum = NA) +
  theme_void() +
  theme(panel.background = element_rect(fill = "#F8F9FA", colour = NA))

print(p)
```

## [Fig 2] ... con Parma in rosso

```{r}
#| label: map-parma
#| eval: true
#| echo: false
#| ouptput: true
#| fig-cap: "Provincia di Parma evidenziata (bordo rosso)."
#| fig-alt: "Confine della Provincia di Parma evidenziato su base dei comuni."
#| out-width: 100%


p2 <- p +
  geom_sf(data = prov_parma, fill = NA, color = "#873C4A", linewidth = 1.2)

print(p2)
```

## [Fig 3] ... con Parma in rosso (etichetta)

```{r}
#| label: label-parma
#| eval: true
#| echo: false
#| ouptput: true
#| fig-cap: "Provincia di Parma evidenziata (bordo rosso)."
#| fig-alt: "Confine della Provincia di Parma evidenziato su base dei comuni."
#| out-width: 100%

prov_parma_lbl <- prov_parma |>
  mutate(label = "Parma", geometry = st_point_on_surface(geometry))

p3 <- p2 +
  geom_sf_text(data = prov_parma_lbl, aes(label = label), size = 4)

print(p3)
```

## [Fig 4] Mappa comuni di Parma
```{r}
#| label: map-comuni-parma
#| eval: true
#| echo: false
#| ouptput: true
#| fig-cap: "Comuni della Provincia di Parma."
#| fig-alt: "Mappa dei comuni della Provincia di Parma."
#| out-width: 100%

comuni_parma <- dplyr::filter(comuni_er, COD_PROV == "34")
p4 <- ggplot() +
  geom_sf(data = comuni_parma, fill = "#f5f5f5", color = "#6a6a6a", linewidth = 0.08) +
  geom_sf(data = prov_parma, fill = NA, color = "#873C4A", linewidth = 1.2) +
  coord_sf(datum = NA) +
  labs(
    title = "Provincia di Parma — Comuni",
    subtitle = "Comuni in grigio chiaro, confine provinciale in rosso",
    caption = "Fonte: ISTAT — Limiti amministrativi al 01/01/2025"
  ) +
  theme_void() +
  theme(panel.background = element_rect(fill = "#F8F9FA", colour = NA))

print(p4)
```

## Salva dati e mappa di Parma in file RDS

Il `driver` indica il formato di output (qui `GeoJSON`, oppure `ESRI Shapefile`, `GPKG`, `KML`, ecc.). Di per se `sf` potrebbe estrapolarlo dal suffisso del file, ma è meglio specificarlo esplicitamente.

```{r}
#| label: save-rds
#| eval: true
#| echo: false

saveRDS(comuni_parma, file = here("data_map_output","comuni_parma.rds"))
st_write(obj = comuni_parma, 
         dsn = here("data_map_output","comuni_parma.geojson"), 
         driver = "GeoJSON", # Chooses the OGR driver.
         delete_dsn = TRUE, # overwrite if exists
         quiet = TRUE # suppress chatter
         )


```

